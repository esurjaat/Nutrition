---
title: "Working File"
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Working File}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r load_libraries, include = FALSE}
library(tidyverse)
library(readr)
library(ggplot2)
library(shinipsum)
library(fakir)
library(usethis)
library(jsonlite)
library(httr)
library(lubridate)
library(kableExtra)
library(shinycssloaders)
library(rvest)
```

# Nutrition Analysis: Shiny Dashboard
## Overview
This is currently a project to utilize Shiny to track nutritional intake.  The user will be able to add ingredients into their library from various sources (e.g. USDA databases, Manual Upload, Nutrition Labels), as well as recipes from various sources (e.g. allrecipes.com, manual entry).  User-friendly data analysis will also then be made available as we input nutritional intake (idea: add features to enable goal setting or compare intake to certain popular diets).


## Data Sources
The possible ways to add ingredients to your personal dashboard are as follows:  
   1. Food Data Central (FDC)
   2. Manual Entry

### Food Data Central ([Link](https://fdc.nal.usda.gov/api-guide.html))
"The USDA National Nutrient Database for Standard Reference is a database produced by the United States Department of Agriculture that provides the nutritional content of many generic and proprietary-branded foods. Released in August 2015 and revised in May 2016, the current release, Standard Reference 28 (SR28), contains "data on 8,800 food items and up to 150 food components".[1] New releases occur about once per year. The database may be searched online,[2] queried through a representational state transfer API,[3] or downloaded"  - Wikipedia

Being able to browse through food items will be a main component of the Shiny project.  To get this data, the user will be able to enter an API-token and a search term to return a list of items to add to their library.  

Current nutrients listed in the FDC database:  
```{r nutrients, echo = FALSE, warning = FALSE}
# Each Set
fdc_branded <- 
  fdc_search(api_key = "",
           search_term = "Chicken Broth Target Stores",
           page_size = 100,
           type = "Branded")

fdc_measured <- 
  fdc_search(api_key = "",
           search_term = "Chicken",
           page_size = 100,
           type = "General")
  
nutrients_branded <- 
  fdc_branded %>% 
  distinct(nutrient_name, nutrient_id) %>% 
  select(nutrient_name, nutrient_id) %>% 
  arrange(nutrient_name, nutrient_id)

nutrients_measured <- 
  fdc_measured %>% 
  distinct(nutrient_name, nutrient_id) %>% 
  select(nutrient_name, nutrient_id)

nutrient_id_used <- 
  tibble(nutrient_id = c(1008, 1003, 1005, 1257, 1258, 1004, 2000, 1093)) %>% 
  mutate(order = 1:nrow(.))

# Joined
nutrients <- 
  nutrients_branded %>% 
  mutate(source = "Branded") %>% 
  bind_rows(nutrients_measured %>% 
              mutate(source = "Measured")) %>% 
  mutate(listed = "X") %>% 
  group_by(nutrient_name, nutrient_id) %>% 
  spread(key = source, value = listed) %>% 
  ungroup() %>% 
  left_join(nutrient_id_used %>% 
              mutate(used = "X"),
            by = "nutrient_id") %>% 
  arrange(order, nutrient_name, nutrient_id) %>% 
  select(-order)
  

# Output
nutrients %>% 
  mutate(across(.cols = Branded:used,
                ~case_when(
                  . == "X" ~ .,
                  TRUE ~ ""))) %>% 
  titler() %>% 
  kbl() %>% 
  kable_styling()
```



# Sandbox ====
```{r sandbox, include = FALSE, }
fdc_branded %>% 
  filter(nutrient_id %in% nutrient_id_used$nutrient_id) %>% 
  mutate(nutrient = case_when(
           nutrient_id == 1008 ~ "Calories (KCal)",
           nutrient_id == 1003 ~ "Protein (g)",
           nutrient_id == 1005 ~ "Carbohydates (g)",
           nutrient_id == 1257 ~ "Fats (trans)",
           nutrient_id == 1258 ~ "Fats (saturated)",
           nutrient_id == 1004 ~ "Total Lipid",
           nutrient_id == 2000 ~ "Sugars total",
           nutrient_id == 1093 ~ "Sodium"),
         nutrient = factor(nutrient, 
                           levels = c("Calories (KCal)", 
                                      "Protein (g)", 
                                      "Carbohydates (g)",
                                      "Fats (trans)", 
                                      "Fats (saturated)",
                                      "Total Lipid",
                                      "Sugars total",
                                      "Sodium"))) %>%  
  select(description,
         fdc_id,
         food_category,
         data_type,
         upc = gtin_upc,
         brand_owner,
         brand_name,
         serving_size_unit,
         serving_size,
         nutrient,
         value) %>% 
  spread(key = nutrient, 
         value = value, 
         fill = 0) %>% 
  titler() %>% 
  kbl() %>% 
  kable_styling()

fdc_measured %>% 
  filter(nutrient_id %in% nutrient_id_used$nutrient_id) %>% 
    mutate(nutrient = case_when(
           nutrient_id == 1008 ~ "Calories (KCal)",
           nutrient_id == 1003 ~ "Protein (g)",
           nutrient_id == 1005 ~ "Carbohydates (g)",
           nutrient_id == 1257 ~ "Fats (trans)",
           nutrient_id == 1258 ~ "Fats (saturated)",
           nutrient_id == 1004 ~ "Total Lipid",
           nutrient_id == 2000 ~ "Sugars total",
           nutrient_id == 1093 ~ "Sodium"),
         nutrient = factor(nutrient, 
                           levels = c("Calories (KCal)", 
                                      "Protein (g)", 
                                      "Carbohydates (g)",
                                      "Fats (trans)", 
                                      "Fats (saturated)",
                                      "Total Lipid",
                                      "Sugars total",
                                      "Sodium"))) %>% 
  select(description,
         fdc_id,
         data_type,
         brand_owner,
         brand_name,
         serving_size_unit,
         serving_size,
         nutrient,
         value)
  

```



# Questions:
1. Can you add a link to the parameter value in a roxygen document? (e.g. I want to link where to sign up for an API key in the '@param' section)

2. I changed a function name in a golem::add_fct() function, but the filename has remained, will this cause issues? What downstream elements do I need to update



